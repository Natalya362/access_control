&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    СтатусЗаявки = "Укажите заявку и нажмите 'Обновить'.";
КонецПроцедуры

&НаСервере
Процедура ОбновитьСтатусЗаявки()
    Если НЕ ЗначениеЗаполнено(Заявка) Тогда
        СтатусЗаявки = "Укажите заявку!";
        Возврат;
    КонецЕсли;

    // Поиск бизнес-процесса по полю Заявка
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |   СогласованиеЗаявки.Ссылка КАК БизнесПроцесс,
    |   СогласованиеЗаявки.Завершен КАК Завершен,
    |   СогласованиеЗаявки.ПометкаУдаления КАК ПометкаУдаления
    |ИЗ
    |   БизнесПроцесс.СогласованиеЗаявки КАК СогласованиеЗаявки
    |ГДЕ
    |   СогласованиеЗаявки.Заявка = &Заявка
    |УПОРЯДОЧИТЬ ПО
    |   СогласованиеЗаявки.Дата УБЫВ";
    
    Запрос.УстановитьПараметр("Заявка", Заявка);
    Результат = Запрос.Выполнить();
    
    Если Результат.Пустой() Тогда
        СтатусЗаявки = "Бизнес-процесс для заявки не найден. Проверьте запуск процесса или пометку удаления.";
        Сообщить("Отладка: Заявка " + Строка(Заявка) + " не имеет связанного бизнес-процесса. Тип заявки: " + ТипЗнч(Заявка));
        // Дополнительная проверка: поиск по номеру и дате для отладки
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |   СогласованиеЗаявки.Ссылка,
        |   СогласованиеЗаявки.Заявка.Номер КАК НомерЗаявки,
        |   СогласованиеЗаявки.Заявка.Дата КАК ДатаЗаявки
        |ИЗ
        |   БизнесПроцесс.СогласованиеЗаявки КАК СогласованиеЗаявки
        |ГДЕ
        |   СогласованиеЗаявки.Заявка.Номер = &Номер
        |   И СогласованиеЗаявки.Заявка.Дата = &Дата";
        Запрос.УстановитьПараметр("Номер", Заявка.Номер);
        Запрос.УстановитьПараметр("Дата", Заявка.Дата);
        РезультатПроверки = Запрос.Выполнить();
        Если НЕ РезультатПроверки.Пустой() Тогда
            Сообщить("Отладка: Найден бизнес-процесс с похожими данными, но ссылка не совпадает. Проверьте тип или данные.");
        КонецЕсли;
        Возврат;
    КонецЕсли;

    Выборка = Результат.Выбрать();
    Выборка.Следующий();
    БизнесПроцесс = Выборка.БизнесПроцесс;
    БизнесПроцессЗавершен = Выборка.Завершен;

    Если Выборка.ПометкаУдаления Тогда
        СтатусЗаявки = "Бизнес-процесс для заявки помечен на удаление.";
        Возврат;
    КонецЕсли;

    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |   ЗадачаИсполнителя.ТочкаМаршрута КАК ТочкаМаршрута,
    |   ЗадачаИсполнителя.РольИсполнителя КАК РольИсполнителя,
    |   ЗадачаИсполнителя.РезультатВыполнения КАК Результат,
    |   ЗадачаИсполнителя.Выполнена КАК Выполнена
    |ИЗ
    |   Задача.ЗадачаИсполнителя КАК ЗадачаИсполнителя
    |ГДЕ
    |   ЗадачаИсполнителя.БизнесПроцесс = &БизнесПроцесс
    |УПОРЯДОЧИТЬ ПО
    |   ЗадачаИсполнителя.Дата УБЫВ";
    
    Запрос.УстановитьПараметр("БизнесПроцесс", БизнесПроцесс);
    Результат = Запрос.Выполнить();
    
    Если Результат.Пустой() Тогда
        Если БизнесПроцессЗавершен Тогда
            СтатусЗаявки = "Заявка завершена. Задачи не найдены.";
        Иначе
            СтатусЗаявки = "Задачи для бизнес-процесса не найдены.";
        КонецЕсли;
        Возврат;
    КонецЕсли;

    Выборка = Результат.Выбрать();
    Выборка.Следующий();

    Если БизнесПроцессЗавершен Тогда
        СтатусЗаявки = "Заявка завершена. Последний результат: " + ?(ЗначениеЗаполнено(Выборка.Результат), Выборка.Результат, "Не указан");
    Иначе
        СтатусЗаявки = "Текущая точка: " + Строка(Выборка.ТочкаМаршрута) + Символы.ПС +
                      "Исполнитель: " + Строка(Выборка.РольИсполнителя) + Символы.ПС +
                      "Статус: " + ?(ЗначениеЗаполнено(Выборка.Результат), Выборка.Результат, "В процессе");
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Обновить(Команда)
    ОбновитьСтатусЗаявки();
КонецПроцедуры