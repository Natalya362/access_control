Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
    Если ЭтоНовый() Тогда
        ЭтотОбъект.УстановитьВремя(РежимАвтоВремя.НеИспользовать);
        Дата = ТекущаяДатаСеанса();
	КонецЕсли; 
	
    // Проверяем, что результат заполнен
    Если НЕ ЗначениеЗаполнено(Результат) Тогда
        Сообщить("Результат проверки должен быть установлен перед записью!");
        Отказ = Истина;
    КонецЕсли;

КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
    СообщениеОбОшибке = "";

    // Проверка обязательных полей
    Если НЕ ЗначениеЗаполнено(Пропуск) Тогда
        Сообщить("Не указан пропуск!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;

    Если НЕ ЗначениеЗаполнено(ЗонаДоступа) Тогда
        Сообщить("Не указана зона доступа!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;

    Если НЕ ЗначениеЗаполнено(ТочкаКонтроля) Тогда
        Сообщить("Не указана точка контроля!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;

    // Проверяем действительность пропуска
    Если НЕ ОбщиеПроверкиПропусков.ПропускДействителен(Пропуск, Дата, СообщениеОбОшибке) Тогда
        Результат = Перечисления.РезультатыПроверки.Запрещен; // Предполагаем перечисление
        Сообщить(СообщениеОбОшибке);
        // Не отказываемся, так как нужно записать результат "Запрещен"
    КонецЕсли;

    // Проверяем соответствие зоны доступа
    Если НЕ ОбщиеПроверкиПропусков.ЗонаДоступаСоответствуетПропуску(Пропуск, ЗонаДоступа, СообщениеОбОшибке) Тогда
        Результат = Перечисления.РезультатыПроверки.Запрещен;
        Сообщить(СообщениеОбОшибке);
        // Не отказываемся, так как нужно записать результат "Запрещен"
    КонецЕсли;

    // Если проверки прошли успешно, устанавливаем "Разрешен"
    Если ПустаяСтрока(СообщениеОбОшибке) Тогда
        Результат = Перечисления.РезультатыПроверки.Разрешен;
    КонецЕсли;

    // Формируем движения
    Если ТипЗнч(Пропуск) = Тип("ДокументСсылка.ВыдачаПропуска") Тогда
        Движения.ДвиженияДоступа.Записывать = Истина;

        Движение = Движения.ДвиженияДоступа.Добавить();
        Движение.Период = Дата;
        Движение.Посетитель = Посетитель;
        Движение.ЗонаДоступа = ЗонаДоступа;
        Движение.ТочкаКонтроля = ТочкаКонтроля;
		Движение.Результат = Результат; 
		
    ИначеЕсли ТипЗнч(Пропуск) = Тип("ДокументСсылка.ВыдачаПропускаНаТС") Тогда
        Движения.ДвиженияТС.Записывать = Истина;
		
        Движение = Движения.ДвиженияТС.Добавить();
        Движение.Период = Дата;
        Движение.Посетитель = Посетитель;  
		Движение.ТранспортноеСредство = ТранспортноеСредство;
        Движение.ЗонаДоступа = ЗонаДоступа;
        Движение.ТочкаКонтроля = ТочкаКонтроля;
		Движение.Результат = Результат; 
	КонецЕсли;    
	
КонецПроцедуры

Процедура ОбработкаУдаленияПроведения(Отказ)
    Если ТипЗнч(Пропуск) = Тип("ДокументСсылка.ВыдачаПропуска") Тогда
        Движения.ДвиженияДоступа.Записывать = Истина;
        Движения.ДвиженияДоступа.Очистить();
    ИначеЕсли ТипЗнч(Пропуск) = Тип("ДокументСсылка.ВыдачаПропускаНаТС") Тогда
        Движения.ДвиженияТС.Записывать = Истина;
        Движения.ДвиженияТС.Очистить();
    КонецЕсли;
КонецПроцедуры
