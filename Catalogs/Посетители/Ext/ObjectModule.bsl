Процедура ПередЗаписью(Отказ)
    // Пропускаем проверку, если запись уже отменена
    Если Отказ Тогда
        Возврат;
    КонецЕсли;

    // Проверка обязательного поля ФизическоеЛицо
    Если НЕ ЗначениеЗаполнено(ЭтотОбъект.ФизическоеЛицо) Тогда
        Сообщить("Поле 'Физическое лицо' не заполнено!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;

    // Формируем наименование на основе ФИО из ФизическоеЛицо
    ЭтотОбъект.Наименование = СокрЛП(ЭтотОбъект.ФизическоеЛицо.Наименование);
    Если НЕ ЗначениеЗаполнено(ЭтотОбъект.Наименование) Тогда
        Сообщить("Наименование физического лица не заполнено в справочнике 'Физические лица'!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;

    // Автоматическое заполнение кода, если он пустой
    Если НЕ ЗначениеЗаполнено(ЭтотОбъект.Код) Тогда
        Запрос = Новый Запрос;
        Запрос.Текст = 
            "ВЫБРАТЬ
            |    Посетители.Код
            |ИЗ
            |    Справочник.Посетители КАК Посетители
            |ГДЕ
            |    НЕ Посетители.ПометкаУдаления";
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        МаксКод = 0;
        Пока Выборка.Следующий() Цикл
            // Пытаемся преобразовать код в число, игнорируя некорректные значения
            Попытка
                ТекКод = Число(Выборка.Код);
                МаксКод = Макс(МаксКод, ТекКод);
            Исключение
                Продолжить;
            КонецПопытки;
        КонецЦикла;
        
        ЭтотОбъект.Код = Формат(МаксКод + 1, "ЧЦ=9; ЧВН=; ЧГ=0");
    КонецЕсли;

    // Проверка уникальности кода
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    Посетители.Ссылка
        |ИЗ
        |    Справочник.Посетители КАК Посетители
        |ГДЕ
        |    Посетители.Код = &Код
        |    И Посетители.Ссылка <> &ТекущаяСсылка
        |    И НЕ Посетители.ПометкаУдаления";
    
    Запрос.УстановитьПараметр("Код", ЭтотОбъект.Код);
    Запрос.УстановитьПараметр("ТекущаяСсылка", ЭтотОбъект.Ссылка);
    
    Результат = Запрос.Выполнить();
    Если НЕ Результат.Пустой() Тогда
        Сообщить("Посетитель с кодом """ + ЭтотОбъект.Код + """ уже существует!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;

    // Проверка уникальности ФизическоеЛицо (одно физическое лицо — один посетитель)
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    Посетители.Ссылка
        |ИЗ
        |    Справочник.Посетители КАК Посетители
        |ГДЕ
        |    Посетители.ФизическоеЛицо = &ФизическоеЛицо
        |    И Посетители.Ссылка <> &ТекущаяСсылка
        |    И НЕ Посетители.ПометкаУдаления";
    
    Запрос.УстановитьПараметр("ФизическоеЛицо", ЭтотОбъект.ФизическоеЛицо);
    Запрос.УстановитьПараметр("ТекущаяСсылка", ЭтотОбъект.Ссылка);
    
    Результат = Запрос.Выполнить();
    Если НЕ Результат.Пустой() Тогда
        Сообщить("Посетитель с физическим лицом """ + ЭтотОбъект.ФизическоеЛицо + """ уже существует!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
КонецПроцедуры